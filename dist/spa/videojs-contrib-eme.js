/*! @name videojs-contrib-eme @version 3.7.0 @license Apache-2.0 */
(function(e,t){"object"===typeof exports&&"undefined"!==typeof module?t(exports,require("global/document"),require("video.js"),require("global/window")):"function"===typeof define&&define.amd?define(["exports","global/document","video.js","global/window"],t):t(e.videojsContribEme={},e.document,e.videojs,e.window)})(this,(function(e,t,n,r){"use strict";function i(){return i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},i.apply(this,arguments)}t=t&&t.hasOwnProperty("default")?t["default"]:t,n=n&&n.hasOwnProperty("default")?n["default"]:n,r=r&&r.hasOwnProperty("default")?r["default"]:r;var s=function(e){for(var t=new ArrayBuffer(2*e.length),n=new Uint16Array(t),r=0;r<e.length;r++)n[r]=e.charCodeAt(r);return n},a=function(e){return String.fromCharCode.apply(null,new Uint16Array(e.buffer))},o=function(e){var n=t.createElement("a");return n.href=e,n.hostname},c=function(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(var n=new DataView(e),r=new DataView(t),i=0;i<n.byteLength;i++)if(n.getUint8(i)!==r.getUint8(i))return!1;return!0},u=function(e){return e instanceof Uint8Array||e instanceof Uint16Array?e.buffer:e},y=function(){var e=n.mergeOptions.apply(n,arguments);return Object.keys(e).forEach((function(t){null===e[t]&&delete e[t]})),e},d=function(e){var t=(new r.DOMParser).parseFromString(String.fromCharCode.apply(null,new Uint16Array(e)),"application/xml"),n=t.getElementsByTagName("HttpHeaders")[0],i={};if(n)for(var s=n.getElementsByTagName("name"),a=n.getElementsByTagName("value"),o=0;o<s.length;o++)i[s[o].childNodes[0].nodeValue]=a[o].childNodes[0].nodeValue;var c,u=t.getElementsByTagName("Challenge")[0];return u&&(c=r.atob(u.childNodes[0].nodeValue)),{headers:i,message:c}},f=function(e,t,r,i){var s=d(t),a=s.message,o=y(s.headers,r.emeHeaders,e.licenseHeaders);n.xhr({uri:e.url,method:"post",headers:o,body:a,responseType:"arraybuffer"},(function(e,t,n){e?i(e):t.statusCode>=400&&t.statusCode<=599?i({}):i(null,n)}))},m=function(e){if(e.supportedConfigurations)return e.supportedConfigurations;var t={},n=e.audioContentType,r=e.audioRobustness,s=e.videoContentType,a=e.videoRobustness,o=e.persistentState;return(n||r)&&(t.audioCapabilities=[i({},n?{contentType:n}:{},r?{robustness:r}:{})]),(s||a)&&(t.videoCapabilities=[i({},s?{contentType:s}:{},a?{robustness:a}:{})]),o&&(t.persistentState=o),[t]},l=function(e){var t;return Object.keys(e).forEach((function(n){var i=m(e[n]);t=t?t.catch((function(e){return r.navigator.requestMediaKeySystemAccess(n,i)})):r.navigator.requestMediaKeySystemAccess(n,i)})),t},p=function(e){var t=e.mediaKeys,r=e.initDataType,i=e.initData,s=e.options,a=e.getLicense,o=e.removeSession,c=e.eventBus,u=t.createSession();return new Promise((function(e,t){u.addEventListener("message",(function(n){a(s,n.message).then((function(t){e(u.update(t))})).catch((function(e){t(e)}))}),!1),u.addEventListener("keystatuseschange",(function(e){var t=!1;u.keyStatuses.forEach((function(r,i){switch(c.trigger({keyId:i,status:r,target:u,type:"keystatuschange"}),r){case"expired":t=!0;break;case"internal-error":n.log.warn('Key status reported as "internal-error." Leaving the session open since we don\'t have enough details to know if this error is fatal.',e);break}})),t&&u.close().then((function(){o(i)}))}),!1),u.generateRequest(r,i).catch((function(){t("Unable to create or initialize key session")}))}))},g=function(e){var t=e.video,n=e.initDataType,r=e.initData,i=e.options,s=e.getLicense,a=e.removeSession,o=e.eventBus;return t.mediaKeysObject?p({mediaKeys:t.mediaKeysObject,initDataType:n,initData:r,options:i,getLicense:s,removeSession:a,eventBus:o}):(t.pendingSessionData.push({initDataType:n,initData:r,options:i,getLicense:s,removeSession:a,eventBus:o}),Promise.resolve())},v=function(e){var t=e.video,n=e.certificate,r=e.createdMediaKeys;t.mediaKeysObject=r;var i=[];n&&i.push(r.setServerCertificate(n));for(var s=0;s<t.pendingSessionData.length;s++){var a=t.pendingSessionData[s];i.push(p({mediaKeys:t.mediaKeysObject,initDataType:a.initDataType,initData:a.initData,options:a.options,getLicense:a.getLicense,removeSession:a.removeSession,eventBus:a.eventBus}))}return t.pendingSessionData=[],i.push(t.setMediaKeys(r)),Promise.all(i)},h=function(e){return function(t,n,r){f(e,n,t,r)}},k=function(e){return function(t,r,i){var s=y({"Content-type":"application/octet-stream"},t.emeHeaders,e.licenseHeaders);n.xhr({uri:e.url,method:"POST",responseType:"arraybuffer",body:r,headers:s},(function(e,t,n){e?i(e):t.statusCode>=400&&t.statusCode<=599?i({}):i(null,n)}))}},b=function(e,t){return function(n,r){return new Promise((function(i,s){e(n,r,(function(e,n){t&&t.trigger("licenserequestattempted"),e?s(e):i(n)}))}))}},S=function(e,t){if("string"===typeof t&&(t={url:t}),!t.url&&!t.getLicense)throw new Error("Neither URL nor getLicense function provided to get license");return t.url&&!t.getLicense&&(t.getLicense="com.microsoft.playready"===e?h(t):k(t)),t},w=function(e){var t,n,r=e.video,i=e.initDataType,s=e.initData,a=e.keySystemAccess,o=e.options,c=e.removeSession,u=e.eventBus,y=Promise.resolve();"undefined"===typeof r.mediaKeysObject&&(r.mediaKeysObject=null,r.pendingSessionData=[],y=new Promise((function(e,i){r.keySystem=a.keySystem,n=S(a.keySystem,o.keySystems[a.keySystem]),n.getCertificate?n.getCertificate(o,(function(n,r){n?i(n):(t=r,e())})):e(a)})).then((function(){return a.createMediaKeys()})).then((function(e){return v({video:r,certificate:t,createdMediaKeys:e})})).catch((function(e){return e?Promise.reject(e):Promise.reject("Failed to create and initialize a MediaKeys object")})));return y.then((function(){return g({video:r,initDataType:i,initData:s,options:o,getLicense:r.keySystem?b(S(r.keySystem,o.keySystems[r.keySystem]).getLicense,u):null,removeSession:c,eventBus:u})}))},D="com.apple.fps.1_0",L=function(e){var t=e.initData,n=e.id,r=e.cert;"string"===typeof n&&(n=s(n));var i=0,a=new ArrayBuffer(t.byteLength+4+n.byteLength+4+r.byteLength),o=new DataView(a),c=new Uint8Array(a,i,t.byteLength);c.set(t),i+=t.byteLength,o.setUint32(i,n.byteLength,!0),i+=4;var u=new Uint16Array(a,i,n.length);u.set(n),i+=u.byteLength,o.setUint32(i,r.byteLength,!0),i+=4;var y=new Uint8Array(a,i,r.byteLength);return y.set(r),new Uint8Array(a,0,a.byteLength)},K=function(e){var t=e.video,n=e.contentId,i=e.initData,s=e.cert,a=e.options,o=e.getLicense,c=e.eventBus;return new Promise((function(e,u){if(!t.webkitKeys)try{t.webkitSetMediaKeys(new r.WebKitMediaKeys(D))}catch(d){return void u("Could not create MediaKeys")}var y;try{y=t.webkitKeys.createSession("video/mp4",L({id:n,initData:i,cert:s}))}catch(d){return void u("Could not create key session")}y.contentId=n,y.addEventListener("webkitkeymessage",(function(e){o(a,n,e.message,(function(e,t){c&&c.trigger("licenserequestattempted"),e?u(e):y.update(new Uint8Array(t))}))})),y.addEventListener("webkitkeyadded",(function(){e()})),y.addEventListener("webkitkeyerror",(function(){var e=y.error;u("KeySession error: code "+e.code+", systemCode "+e.systemCode)}))}))},C=function(e){return function(t,r){var i=y(t.emeHeaders,e.certificateHeaders);n.xhr({uri:e.certificateUri,responseType:"arraybuffer",headers:i},(function(e,t,n){e?r(e):r(null,new Uint8Array(n))}))}},E=function(e,t){return o(a(t))},_=function(e){return function(t,r,i,s){var a=y({"Content-type":"application/octet-stream"},t.emeHeaders,e.licenseHeaders);n.xhr({uri:e.licenseUri,method:"POST",responseType:"arraybuffer",body:i,headers:a},(function(e,t,n){e?s(e):t.statusCode>=400&&t.statusCode<=599?s({}):s(null,n)}))}},U=function(e){var t=e.video,n=e.initData,r=e.options,i=e.eventBus,s=r.keySystems[D],a=s.getCertificate||C(s),o=s.getContentId||E,c=s.getLicense||_(s);return new Promise((function(e,t){a(r,(function(n,r){n?t(n):e(r)}))})).then((function(e){return K({video:t,cert:e,initData:n,getLicense:c,options:r,contentId:o(r,n),eventBus:i})}))},T="com.microsoft.playready",M=function(e,t,n,r){var i=e.keySystems[T];if("function"!==typeof i.getKey){"string"===typeof i?i={url:i}:"boolean"===typeof i&&(i={}),i.url||(i.url=n.destinationURL);var s=function(e,n){r&&r.trigger("licenserequestattempted"),e?r.trigger({message:"Unable to request key from url: "+i.url,target:t,type:"mskeyerror"}):t.update(new Uint8Array(n))};i.getLicense?i.getLicense(e,n.message.buffer,s):f(i,n.message.buffer,e,s)}else i.getKey(e,n.destinationURL,n.message.buffer,(function(e,n){e?r.trigger({message:"Unable to get key: "+e,target:t,type:"mskeyerror"}):t.update(n)}))},P=function(e,t,n,r){var i=e.msKeys.createSession("video/mp4",t);if(!i)throw new Error("Could not create key session.");i.addEventListener("mskeymessage",(function(e){M(n,i,e,r)})),i.addEventListener("mskeyerror",(function(e){r.trigger({message:"Unexpected key error from key session with code: "+i.error.code+" and systemCode: "+i.error.systemCode,target:i,type:"mskeyerror"})})),i.addEventListener("mskeyadded",(function(){r.trigger({target:i,type:"mskeyadded"})}))},O=function(e){var t=e.video,n=e.initData,i=e.options,s=e.eventBus;t.msKeys&&delete t.msKeys;try{t.msSetMediaKeys(new r.MSMediaKeys(T))}catch(a){throw new Error("Unable to create media keys for PlayReady key system. Error: "+a.message)}P(t,n,i,s)},B=function(e,t){for(var n=0;n<e.length;n++)if(e[n].initData){var r=u(e[n].initData),i=u(t);if(c(r,i))return!0}return!1},j=function(e,t){for(var n=0;n<e.length;n++)if(e[n].initData===t)return void e.splice(n,1)},A=function(e,t,n,r){if(!t||!t.keySystems)return Promise.resolve();var i=e.initData;return l(t.keySystems).then((function(s){var a=s.keySystem;return t.keySystems[a]&&t.keySystems[a].pssh&&(i=t.keySystems[a].pssh),B(n,i)||!i?Promise.resolve():(n.push({initData:i}),w({video:e.target,initDataType:e.initDataType,initData:i,keySystemAccess:s,options:t,removeSession:j.bind(null,n),eventBus:r}))}))},H=function(e,t,n){return t.keySystems&&t.keySystems[D]&&e.initData?U({video:e.target,initData:e.initData,options:t,eventBus:n}):Promise.resolve()},N=function(e,t,n,r){if(t.keySystems&&t.keySystems[T]&&!n.reduce((function(e,t){return e||t.playready}),!1)){var i=e.initData;t.keySystems[T]&&t.keySystems[T].pssh&&(i=t.keySystems[T].pssh),i&&(n.push({playready:!0,initData:i}),O({video:e.target,initData:i,options:t,eventBus:r}))}},q=function(e){return n.mergeOptions(e.currentSource(),e.eme.options)},x=function(e){var t=e.src();t!==e.eme.activeSrc&&(e.eme.activeSrc=t,e.eme.sessions=[])},R=function(e){return function(t){var n="string"===typeof t?t:t&&t.message||null;e.error({code:5,message:n})}},V=function(e,t){"video"===e.$(".vjs-tech").tagName.toLowerCase()&&(x(e),r.WebKitMediaKeys?e.tech_.el_.addEventListener("webkitneedkey",(function(n){x(e),H(n,q(e),e.tech_).catch(t)})):r.MediaKeys?e.tech_.el_.addEventListener("encrypted",(function(n){x(e),A(n,q(e),e.eme.sessions,e.tech_).catch(t)})):r.MSMediaKeys&&(e.tech_.el_.addEventListener("msneedkey",(function(n){x(e);try{N(n,q(e),e.eme.sessions,e.tech_)}catch(r){t(r)}})),e.tech_.on("mskeyerror",t),e.on("dispose",(function(){e.tech_.off("mskeyerror",t)}))))},I=function(e){void 0===e&&(e={});var t=this,r=R(t);t.ready((function(){return V(t,r)})),t.eme={initializeMediaKeys:function(i,s,a){void 0===i&&(i={}),void 0===s&&(s=function(){}),void 0===a&&(a=!1);var o=n.mergeOptions(t.currentSource(),e,i),c={initDataType:"cenc",initData:null,target:t.tech_.el_};if(x(t),t.tech_.el_.setMediaKeys)A(c,o,t.eme.sessions,t.tech_).then((function(){return s()})).catch((function(e){s(e),a||r(e)}));else if(t.tech_.el_.msSetMediaKeys){var u=function e(n){t.tech_.off("mskeyadded",e),t.tech_.off("mskeyerror",e),"mskeyerror"===n.type?(s(n.target.error),a||r(n.message)):s()};t.tech_.one("mskeyadded",u),t.tech_.one("mskeyerror",u);try{N(c,o,t.eme.sessions,t.tech_)}catch(y){t.tech_.off("mskeyadded",u),t.tech_.off("mskeyerror",u),s(y),a||r(y)}}},options:e}},z=n.registerPlugin||n.plugin;z("eme",I),e.hasSession=B,e.removeSession=j,e.handleEncryptedEvent=A,e.handleWebKitNeedKeyEvent=H,e.handleMsNeedKeyEvent=N,e.getOptions=q,e.setupSessions=x,e.emeErrorHandler=R,e.default=I,Object.defineProperty(e,"__esModule",{value:!0})}));